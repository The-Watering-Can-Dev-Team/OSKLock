<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<Product Id="*" Name="OSK Mover Tray App" Language="1033" Version="1.0.0.4" Manufacturer="The Watering Can" UpgradeCode="BD8302DA-846E-47EA-97C2-E1B036306BB3">
		<Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine"
			Comments="OSK Mover Tray App" Manufacturer="The Watering Can"
			Description="This is a utility to move (lock) the on-screen keyboard window."
			InstallPrivileges="elevated" />
		
		<!-- Major Upgrade to uninstall the old version when a new one is installed -->
		<MajorUpgrade
		  AllowDowngrades="no"
		  DowngradeErrorMessage="A newer version of OSK Mover Tray App is already installed."
		  Schedule="afterInstallInitialize"
		  RemoveFeatures="ALL" />

		<!-- Minor upgrade configuration to update within the same version family -->
		<Upgrade Id="BD8302DA-846E-47EA-97C2-E1B036306BB3">
			<UpgradeVersion OnlyDetect="no" Property="PREVIOUSFOUND"
							Minimum="1.0.0.0" IncludeMinimum="yes"
							Maximum="2.0.0.0" IncludeMaximum="no" />
			<!-- Set "PREVIOUSFOUND" if a previous version is detected -->
		</Upgrade>

		<!-- Provide the manufacturer information in the summary -->
		<Property Id="ARPCONTACT">itsupport@thewateringcan.ca</Property>
		<Property Id="ARPCOMMENTS">Utility to move the on-screen keyboard</Property>
		<Property Id="ARPURLINFOABOUT">https://thewateringcan.ca</Property>
		<Property Id="ARPURLUPDATEINFO">https://github.com/The-Watering-Can-Dev-Team/OSKLock/releases</Property>
		
		<!-- Prevent installation if the product is already installed -->
		<Condition Message="OSK Mover Tray App is already installed.">
			(NOT Installed) OR (REMOVE="ALL")
		</Condition>
		
		<!-- Define the media used for the installer -->
		<Media Id="1" Cabinet="cab1.cab" EmbedCab="yes" />

		<!-- Installation directory -->
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLFOLDER" Name="OSK Mover Tray App">

					<!-- Application executable -->
					<Component Id="MainApplicationComponent" Guid="*">
						<File Id="OSKTrayAppFile" Source="$(var.OSKTrayApp.TargetDir)OSKTrayApp.exe" KeyPath="yes" />
					</Component>

				</Directory>
			</Directory>
			<Directory Id="SystemFolder" Name="System32" />
		</Directory>

		<!-- Feature to install components -->
		<Feature Id="MainFeature" Title="OSK Mover Tray App" Level="1">
			<ComponentRef Id="MainApplicationComponent" />
		</Feature>

		<!-- Create the scheduled task -->
		<CustomAction Id="CreateTaskSchedulerTask"
				  Directory="SystemFolder"
				  ExeCommand='schtasks /Create /TN "OSKTrayApp" /TR "\"[INSTALLFOLDER]OSKTrayApp.exe\"" /SC ONLOGON /RL HIGHEST /F /RU "Users" /IT'
				  Execute="deferred"
				  Return="check"
				  Impersonate="no" />
		
		<CustomAction Id="RunTaskOnce"
					  Directory="SystemFolder"
					  ExeCommand='schtasks /Run /TN "OSKTrayApp"'
					  Execute="deferred"
					  Return="check"
					  Impersonate="no" />

		<!-- Delete the scheduled task during uninstall -->
		<CustomAction Id="DeleteTaskSchedulerTask"
					  Directory="SystemFolder"
					  ExeCommand='schtasks /Delete /TN "OSKTrayApp" /F'
					  Execute="deferred"
					  Return="ignore"
					  Impersonate="no" />

		<CustomAction Id="KillTrayApp"
              Directory="SystemFolder"
              ExeCommand='taskkill /F /IM "OSKTrayApp.exe" /T'
              Execute="deferred"
              Return="ignore"
              Impersonate="no" />

		<!-- Define when to create and delete the task -->
		<InstallExecuteSequence>
			<Custom Action="CreateTaskSchedulerTask" After="InstallFiles">NOT Installed</Custom>
			<Custom Action="RunTaskOnce" After="CreateTaskSchedulerTask">NOT Installed</Custom>
			<!-- Custom action for killing the tray app during uninstall -->
			<Custom Action="KillTrayApp" Before="RemoveFiles">Installed</Custom>
			<Custom Action="DeleteTaskSchedulerTask" Before="RemoveFiles">Installed</Custom>
		</InstallExecuteSequence>

	</Product>
</Wix>
